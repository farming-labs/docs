/**
 * Next.js config wrapper for @farming-labs/docs.
 * Handles MDX compilation, frontmatter, syntax highlighting, TOC extraction,
 * and auto-generates mdx-components.tsx + docs layout when missing.
 *
 * @example
 * // next.config.ts — this is all you need:
 *   import { withDocs } from "@farming-labs/next/config";
 *   export default withDocs();
 *
 * @example
 * // With existing Next.js config
 *   import { withDocs } from "@farming-labs/next/config";
 *   export default withDocs({
 *     images: { remotePatterns: [{ hostname: "example.com" }] },
 *   });
 */

import { existsSync, readFileSync, writeFileSync, mkdirSync } from "node:fs";
import { join } from "node:path";

// @ts-ignore – no types needed at config time
import createMDX from "@next/mdx";

// ─── Auto-generated file templates ──────────────────────────────────

const GENERATED_BANNER = "// Auto-generated by @farming-labs/next — do not edit manually.\n";

const MDX_COMPONENTS_TEMPLATE = `\
${GENERATED_BANNER}
import { getMDXComponents } from "@farming-labs/fumadocs/mdx";
import type { MDXComponents } from "mdx/types";
import docsConfig from "@/docs.config";

export function useMDXComponents(components?: MDXComponents): MDXComponents {
  return getMDXComponents({
    ...(docsConfig.components as MDXComponents),
    ...components,
  });
}
`;

const DOCS_LAYOUT_TEMPLATE = `\
${GENERATED_BANNER}
import docsConfig from "@/docs.config";
import { createDocsLayout, createDocsMetadata } from "@farming-labs/fumadocs";

export const metadata = createDocsMetadata(docsConfig);
export default createDocsLayout(docsConfig);
`;

const SEARCH_ROUTE_TEMPLATE = `\
${GENERATED_BANNER}
import { createDocsSearchAPI } from "@farming-labs/fumadocs/search";

export const { GET } = createDocsSearchAPI();

export const revalidate = false;
`;

// ─── Helpers ────────────────────────────────────────────────────────

const FILE_EXTS = ["tsx", "ts", "jsx", "js"];

function hasFile(root: string, baseName: string): boolean {
  return FILE_EXTS.some((ext) => existsSync(join(root, `${baseName}.${ext}`)));
}

/** Read the docs entry path from docs.config.ts[x] (defaults to "docs"). */
function readDocsEntry(root: string): string {
  for (const ext of FILE_EXTS) {
    const configPath = join(root, `docs.config.${ext}`);
    if (existsSync(configPath)) {
      try {
        const content = readFileSync(configPath, "utf-8");
        // Match entry: "..." or entry: '...' in the config
        const match = content.match(/entry\s*:\s*["']([^"']+)["']/);
        if (match) return match[1];
      } catch {
        // fall through to default
      }
    }
  }
  return "docs";
}

// ─── withDocs ───────────────────────────────────────────────────────

export function withDocs(nextConfig: Record<string, unknown> = {}) {
  const root = process.cwd();

  // ── 1. Auto-generate mdx-components.tsx if missing ──────────────
  if (!hasFile(root, "mdx-components")) {
    writeFileSync(join(root, "mdx-components.tsx"), MDX_COMPONENTS_TEMPLATE);
  }

  // ── 2. Auto-generate app/{entry}/layout.tsx if missing ──────────
  const entry = readDocsEntry(root);
  const layoutDir = join(root, "app", entry);
  if (existsSync(layoutDir) && !hasFile(layoutDir, "layout")) {
    writeFileSync(join(layoutDir, "layout.tsx"), DOCS_LAYOUT_TEMPLATE);
  } else if (!existsSync(layoutDir)) {
    mkdirSync(layoutDir, { recursive: true });
    writeFileSync(join(layoutDir, "layout.tsx"), DOCS_LAYOUT_TEMPLATE);
  }

  // ── 3. Auto-generate app/api/search/route.ts if missing ────────
  const searchRouteDir = join(root, "app", "api", "search");
  if (!hasFile(searchRouteDir, "route")) {
    mkdirSync(searchRouteDir, { recursive: true });
    writeFileSync(join(searchRouteDir, "route.ts"), SEARCH_ROUTE_TEMPLATE);
  }

  // ── 4. Configure MDX compilation ────────────────────────────────
  // All plugins are passed as string specifiers so that loader options
  // remain JSON-serializable. This is required for Turbopack compatibility.
  // @mdx-js/loader resolves the strings to actual plugin functions at
  // compile time.
  const withMDX = createMDX({
    extension: /\.mdx?$/,
    options: {
      remarkPlugins: [
        "remark-gfm",
        "remark-frontmatter",
        ["remark-mdx-frontmatter", { name: "metadata" }],
        "@farming-labs/next/mdx-plugins/remark-heading",
      ],
      rehypePlugins: [
        "@farming-labs/next/mdx-plugins/rehype-toc",
        [
          "@farming-labs/next/mdx-plugins/rehype-code",
          { themes: { dark: "github-dark", light: "github-light" } },
        ],
      ],
    },
  });

  // ── 5. Ensure pageExtensions includes md/mdx ───────────────────
  const defaultExts = ["js", "jsx", "md", "mdx", "ts", "tsx"];
  const userExts = nextConfig.pageExtensions as string[] | undefined;

  if (userExts) {
    for (const ext of ["md", "mdx"]) {
      if (!userExts.includes(ext)) {
        userExts.push(ext);
      }
    }
  } else {
    nextConfig.pageExtensions = defaultExts;
  }

  return withMDX(nextConfig);
}
