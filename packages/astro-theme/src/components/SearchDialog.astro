---
const { config = null } = Astro.props;
---

<!-- Omni command palette — same structure as website/components/ui/omni-command-palette.tsx -->
<div id="fd-search-dialog" style="display: none;">
  <div class="omni-overlay" id="fd-omni-overlay" aria-hidden="true"></div>
  <div class="omni-content" id="fd-omni-content" role="dialog" aria-label="Search documentation">
    <div class="omni-header">
      <div class="omni-search-row">
        <span class="omni-search-icon" aria-hidden="true">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.3-4.3" />
          </svg>
        </span>
        <input
          type="text"
          id="fd-omni-input"
          class="omni-search-input"
          role="combobox"
          aria-expanded="true"
          aria-controls="fd-omni-listbox"
          placeholder="Search documentation…"
          autocomplete="off"
        />
        <kbd class="omni-kbd">⌘K</kbd>
        <button type="button" aria-label="Close" class="omni-close-btn" id="fd-omni-close">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M18 6 6 18" />
            <path d="m6 6 12 12" />
          </svg>
        </button>
      </div>
    </div>

    <div class="omni-body" id="fd-omni-listbox" role="listbox" aria-label="Search results">
      <div class="omni-loading" id="fd-omni-loading" style="display: none;">
        <svg class="omni-spin" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M21 12a9 9 0 1 1-6.219-8.56" />
        </svg>
        Searching…
      </div>
      <div id="fd-omni-recent-group" class="omni-group" style="display: none;">
        <div class="omni-group-label">Recent</div>
        <div class="omni-group-items" id="fd-omni-recent-items"></div>
      </div>
      <div id="fd-omni-docs-group" class="omni-group" style="display: none;">
        <div class="omni-group-label">Documentation</div>
        <div class="omni-group-items" id="fd-omni-docs-items"></div>
      </div>
      <div class="omni-empty" id="fd-omni-empty">
        <div class="omni-empty-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 6v6l4 2" />
          </svg>
        </div>
        <span id="fd-omni-empty-text">Type to search the docs, or browse recent items.</span>
      </div>
    </div>

    <div class="omni-footer">
      <div class="omni-footer-inner">
        <div class="omni-footer-hints">
          <span class="omni-footer-hint">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <polyline points="9 18 15 12 9 6" />
            </svg>
            to select
          </span>
          <span class="omni-footer-hint">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M18 15l-6-6-6 6" />
            </svg>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M6 9l6 6 6-6" />
            </svg>
            to navigate
          </span>
          <span class="omni-footer-hint omni-footer-hint-desktop">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M18 6 6 18" />
              <path d="m6 6 12 12" />
            </svg>
            to close
          </span>
        </div>
      </div>
    </div>
  </div>
</div>

<script is:inline>
(function () {
  var STORAGE_KEY = "fd:omni:recents";
  var MAX_RECENTS = 8;
  var DEBOUNCE_MS = 150;

  function getDialog() { return document.getElementById("fd-search-dialog"); }
  function getOverlay() { return document.getElementById("fd-omni-overlay"); }
  function getContent() { return document.getElementById("fd-omni-content"); }
  function getInput() { return document.getElementById("fd-omni-input"); }
  function getListbox() { return document.getElementById("fd-omni-listbox"); }
  function getLoading() { return document.getElementById("fd-omni-loading"); }
  function getRecentGroup() { return document.getElementById("fd-omni-recent-group"); }
  function getRecentItems() { return document.getElementById("fd-omni-recent-items"); }
  function getDocsGroup() { return document.getElementById("fd-omni-docs-group"); }
  function getDocsItems() { return document.getElementById("fd-omni-docs-items"); }
  function getEmpty() { return document.getElementById("fd-omni-empty"); }
  function getEmptyText() { return document.getElementById("fd-omni-empty-text"); }

  function getRecents() {
    try {
      var raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch (e) { return []; }
  }

  function saveRecent(entry) {
    try {
      var recents = getRecents();
      var next = [entry].concat(recents.filter(function (r) { return r.id !== entry.id; })).slice(0, MAX_RECENTS);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
    } catch (e) {}
  }

  function openDialog() {
    var dialog = getDialog();
    if (dialog) {
      dialog.style.display = "block";
      document.body.style.overflow = "hidden";
      bindListboxDelegation();
      ensureListboxClickBound();
      setTimeout(function () {
        var input = getInput();
        if (input) { input.value = ""; input.focus(); }
        render();
      }, 10);
    }
  }

  function closeDialog() {
    var dialog = getDialog();
    if (dialog) {
      dialog.style.display = "none";
      document.body.style.overflow = "";
    }
  }

  function stripHtml(html) {
    if (typeof document === "undefined") return (html || "").replace(/<[^>]+>/g, "");
    var el = document.createElement("div");
    el.innerHTML = html || "";
    return el.textContent || el.innerText || "";
  }

  var fileIconSvg = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>';
  var externalSvg = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>';
  var chevronSvg = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>';

  function renderItem(item, active, isRecent) {
    var label = (item.label || item.content || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    var subtitle = (item.subtitle || item.description || (isRecent ? "Recently viewed" : "Page")).replace(/</g, "&lt;").replace(/>/g, "&gt;");
    var url = item.url || "#";
    var id = (item.id || url).replace(/[^a-zA-Z0-9-_]/g, "_");
    var safeUrl = url.replace(/&/g, "&amp;").replace(/"/g, "&quot;");
    var activeClass = active ? " omni-item-active" : "";
    return (
      '<div class="omni-item' + activeClass + '" data-id="' + id + '" data-url="' + url.replace(/"/g, "&quot;") + '" role="option" aria-selected="' + (active ? "true" : "false") + '" tabindex="-1">' +
        '<div class="omni-item-icon">' + fileIconSvg + '</div>' +
        '<div class="omni-item-text">' +
          '<div class="omni-item-label">' + label + '</div>' +
          '<div class="omni-item-subtitle">' + subtitle + '</div>' +
        '</div>' +
        '<a href="' + safeUrl + '" class="omni-item-ext" title="Open in new tab" target="_blank" rel="noopener noreferrer" data-ext-url="' + url.replace(/"/g, "&quot;") + '">' + externalSvg + '</a>' +
        '<span class="omni-item-chevron" aria-hidden="true">' + chevronSvg + '</span>' +
      '</div>'
    );
  }

  var debounceTimer = null;
  var currentResults = [];
  var recentsList = [];
  var activeIndex = 0;

  function allItems() {
    var q = (getInput() && getInput().value || "").trim();
    if (q && currentResults.length) return currentResults;
    return recentsList;
  }

  function render() {
    var input = getInput();
    var q = input ? input.value.trim() : "";
    var loadingEl = getLoading();
    var recentGroup = getRecentGroup();
    var recentItemsEl = getRecentItems();
    var docsGroup = getDocsGroup();
    var docsItemsEl = getDocsItems();
    var emptyEl = getEmpty();
    var emptyText = getEmptyText();

    recentsList = !q ? getRecents() : [];
    if (loadingEl && !q) loadingEl.style.display = "none";

    if (!q) {
      currentResults = [];
      if (recentGroup) recentGroup.style.display = recentsList.length ? "block" : "none";
      if (recentItemsEl) {
        recentItemsEl.innerHTML = recentsList.map(function (r, i) {
          return renderItem(
            { id: r.id, label: r.label, url: r.url, subtitle: "Recently viewed" },
            i === activeIndex,
            true
          );
        }).join("");
      }
      if (docsGroup) docsGroup.style.display = "none";
      if (docsItemsEl) docsItemsEl.innerHTML = "";
      if (emptyEl) emptyEl.style.display = (recentsList.length === 0) ? "block" : "none";
      if (emptyText) emptyText.textContent = "Type to search the docs, or browse recent items.";
    } else {
      if (recentGroup) recentGroup.style.display = "none";
      if (docsGroup) docsGroup.style.display = currentResults.length ? "block" : "none";
      if (docsItemsEl) {
        docsItemsEl.innerHTML = currentResults.map(function (r, i) {
          return renderItem(
            { id: r.url, label: r.content, url: r.url, subtitle: r.description || "Page" },
            i === activeIndex,
            false
          );
        }).join("");
      }
      if (emptyEl) emptyEl.style.display = (currentResults.length === 0 && !loadingEl.style.display) ? "none" : (currentResults.length === 0 ? "block" : "none");
      if (emptyText) emptyText.textContent = "No results found. Try a different query.";
    }

    scrollActiveIntoView();
  }

  function navigateToUrl(url, newTab) {
    if (!url) return;
    if (newTab || url.startsWith("http")) {
      try {
        window.open(url, "_blank", "noopener,noreferrer");
      } catch (err) {
        window.location.assign(url);
      }
    } else {
      window.location.assign(url);
    }
  }

  function handleOmniItemClick(e) {
    var dialog = getDialog();
    if (!dialog || dialog.style.display === "none") return;
    var withinDialog = e.target.closest && e.target.closest("#fd-search-dialog");
    if (!withinDialog) return;

    var ext = e.target.closest && e.target.closest("a.omni-item-ext");
    if (ext) {
      e.preventDefault();
      e.stopPropagation();
      var url = ext.getAttribute("data-ext-url") || ext.getAttribute("href");
      navigateToUrl(url, true);
      return;
    }
    var row = e.target.closest && e.target.closest(".omni-item[data-url]");
    if (row) {
      e.preventDefault();
      e.stopPropagation();
      var url = row.getAttribute("data-url");
      if (!url) return;
      var labelEl = row.querySelector(".omni-item-label");
      var label = labelEl ? labelEl.textContent : url;
      saveRecent({ id: url, label: label, url: url });
      closeDialog();
      navigateToUrl(url, url.startsWith("http"));
    }
  }

  function handleOmniItemMouseOver(e) {
    var dialog = getDialog();
    if (!dialog || dialog.style.display === "none") return;
    var row = e.target.closest && e.target.closest(".omni-item[data-url]");
    if (row) {
      var container = row.closest("#fd-omni-recent-items") || row.closest("#fd-omni-docs-items");
      if (container) {
        var items = container.querySelectorAll(".omni-item[data-url]");
        var idx = Array.prototype.indexOf.call(items, row);
        if (idx >= 0) { activeIndex = idx; render(); }
      }
    }
  }

  function bindListboxDelegation() {
    if (document.body.hasAttribute("data-fd-omni-click-delegation")) return;
    document.body.setAttribute("data-fd-omni-click-delegation", "true");
    document.addEventListener("click", handleOmniItemClick, true);
    document.addEventListener("mouseover", handleOmniItemMouseOver, true);
  }

  function ensureListboxClickBound() {
    var listbox = getListbox();
    if (!listbox || listbox._fdOmniClickBound) return;
    listbox._fdOmniClickBound = true;
    function onListboxClick(e) {
      var ext = e.target.closest && e.target.closest("a.omni-item-ext");
      if (ext) {
        e.preventDefault();
        e.stopPropagation();
        var url = ext.getAttribute("data-ext-url") || ext.getAttribute("href");
        navigateToUrl(url, true);
        return;
      }
      var row = e.target.closest && e.target.closest(".omni-item[data-url]");
      if (row) {
        e.preventDefault();
        e.stopPropagation();
        var url = row.getAttribute("data-url");
        if (!url) return;
        var labelEl = row.querySelector(".omni-item-label");
        var label = labelEl ? labelEl.textContent : url;
        saveRecent({ id: url, label: label, url: url });
        closeDialog();
        navigateToUrl(url, url.startsWith("http"));
      }
    }
    listbox.addEventListener("click", onListboxClick, true);
  }

  function scrollActiveIntoView() {
    var q = getInput() && getInput().value.trim();
    var container = q ? getDocsItems() : getRecentItems();
    if (!container) return;
    var items = container.querySelectorAll(".omni-item[data-url]");
    if (items[activeIndex]) items[activeIndex].scrollIntoView({ block: "nearest" });
  }

  function moveActive(delta) {
    var items = allItems();
    if (!items.length) return;
    activeIndex = activeIndex + delta;
    if (activeIndex < 0) activeIndex = items.length - 1;
    if (activeIndex >= items.length) activeIndex = 0;
    render();
  }

  function executeActive() {
    var items = allItems();
    if (items[activeIndex]) {
      var it = items[activeIndex];
      saveRecent({ id: it.url, label: it.content || it.label, url: it.url });
      if (it.url.startsWith("http")) window.open(it.url, "_blank", "noopener");
      else window.location.href = it.url;
      closeDialog();
    }
  }

  function onInput() {
    var input = getInput();
    var q = (input && input.value || "").trim();
    if (getLoading()) getLoading().style.display = "none";
    currentResults = [];
    activeIndex = 0;
    if (getDocsGroup()) getDocsGroup().style.display = "none";
    if (getDocsItems()) getDocsItems().innerHTML = "";
    if (getRecentGroup()) getRecentGroup().style.display = !q && getRecents().length ? "block" : "none";
    if (getEmpty()) getEmpty().style.display = "block";
    if (getEmptyText()) getEmptyText().textContent = !q ? "Type to search the docs, or browse recent items." : "No results found. Try a different query.";
    render();

    clearTimeout(debounceTimer);
    if (!q) return;
    debounceTimer = setTimeout(function () {
      if (getLoading()) getLoading().style.display = "flex";
      fetch("/api/docs?query=" + encodeURIComponent(q))
        .then(function (res) { return res.ok ? res.json() : []; })
        .then(function (data) {
          currentResults = Array.isArray(data) ? data : [];
          activeIndex = 0;
          if (getLoading()) getLoading().style.display = "none";
          render();
        })
        .catch(function () {
          if (getLoading()) getLoading().style.display = "none";
          render();
        });
    }, DEBOUNCE_MS);
  }

  function init() {
    var dialog = getDialog();
    var overlay = getOverlay();
    var content = getContent();
    var input = getInput();
    var closeBtn = document.getElementById("fd-omni-close");

    if (!dialog || !input) return;

    overlay && overlay.addEventListener("click", closeDialog);
    closeBtn && closeBtn.addEventListener("click", closeDialog);
    content && content.addEventListener("click", function (e) { e.stopPropagation(); });

    input.addEventListener("input", onInput);
    input.addEventListener("keydown", function (e) {
      if (e.key === "ArrowDown") { e.preventDefault(); moveActive(1); }
      else if (e.key === "ArrowUp") { e.preventDefault(); moveActive(-1); }
      else if (e.key === "Enter") { e.preventDefault(); executeActive(); }
    });

    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") closeDialog();
    });

    if (!document.body.hasAttribute("data-fd-cmdk-registered")) {
      document.body.setAttribute("data-fd-cmdk-registered", "true");
      document.addEventListener("keydown", function (e) {
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
          e.preventDefault();
          if (getDialog().style.display !== "none") closeDialog();
          else openDialog();
        }
      });
    }
    bindListboxDelegation();
  }

  function setOpen(open) {
    if (open) openDialog();
    else closeDialog();
  }
  window.__fdOmniSearchOpen = openDialog;
  window.__fdOmniSearchClose = closeDialog;
  window.__fdOmniSearchSetOpen = setOpen;

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
  document.addEventListener("astro:page-load", init);
})();
</script>
