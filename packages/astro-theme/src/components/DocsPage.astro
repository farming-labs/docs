---
const {
  tocEnabled = true,
  tocStyle = "default",
  breadcrumbEnabled = true,
  entry = "docs",
  previousPage = null,
  nextPage = null,
  editOnGithub = null,
  lastModified = null,
  llmsTxtEnabled = false,
} = Astro.props;

const pathname = Astro.url.pathname;
const segments = pathname.split("/").filter(Boolean);
const parentLabel = segments.length >= 2 ? segments[segments.length - 2].replace(/-/g, " ").replace(/\b\w/g, c => c.toUpperCase()) : "";
const currentLabel = segments.length >= 2 ? segments[segments.length - 1].replace(/-/g, " ").replace(/\b\w/g, c => c.toUpperCase()) : "";
const parentUrl = segments.length >= 2
  ? "/" + segments.slice(0, segments.length - 1).join("/")
  : "";
---

<div class="fd-page">
  <article class="fd-page-article" id="nd-page">
    {breadcrumbEnabled && segments.length >= 2 && (
      <nav class="fd-breadcrumb" aria-label="Breadcrumb">
        <span class="fd-breadcrumb-item">
          <a href={parentUrl} class="fd-breadcrumb-parent fd-breadcrumb-link">{parentLabel}</a>
        </span>
        <span class="fd-breadcrumb-item">
          <span class="fd-breadcrumb-sep">/</span>
          <span class="fd-breadcrumb-current">{currentLabel}</span>
        </span>
      </nav>
    )}

    <div class="fd-page-body">
      <div class="fd-docs-content">
        <slot />
      </div>
    </div>

    <footer class="fd-page-footer">
      {(editOnGithub || lastModified || llmsTxtEnabled) && (
        <div class="fd-edit-on-github">
          {editOnGithub && (
            <a href={editOnGithub} target="_blank" rel="noopener noreferrer">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
              Edit on GitHub
            </a>
          )}
          {llmsTxtEnabled && (
            <span class="fd-llms-txt-links">
              <a href="/api/docs?format=llms" target="_blank" rel="noopener noreferrer" class="fd-llms-txt-link">llms.txt</a>
              <a href="/api/docs?format=llms-full" target="_blank" rel="noopener noreferrer" class="fd-llms-txt-link">llms-full.txt</a>
            </span>
          )}
          {lastModified && (
            <span class="fd-last-modified">Last updated: {lastModified}</span>
          )}
        </div>
      )}

      {(previousPage || nextPage) && (
        <nav class="fd-page-nav" aria-label="Page navigation">
          {previousPage ? (
            <a href={previousPage.url} class="fd-page-nav-card fd-page-nav-prev">
              <span class="fd-page-nav-label">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="15 18 9 12 15 6" />
                </svg>
                Previous
              </span>
              <span class="fd-page-nav-title">{previousPage.name}</span>
            </a>
          ) : <div />}
          {nextPage ? (
            <a href={nextPage.url} class="fd-page-nav-card fd-page-nav-next">
              <span class="fd-page-nav-label">
                Next
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="9 18 15 12 9 6" />
                </svg>
              </span>
              <span class="fd-page-nav-title">{nextPage.name}</span>
            </a>
          ) : <div />}
        </nav>
      )}
    </footer>
  </article>

  {tocEnabled && (
    <aside class="fd-toc" id="fd-toc" data-toc-ready="false">
      <div class={`fd-toc-inner ${tocStyle === "directional" ? "fd-toc-directional" : ""}`} data-toc-style={tocStyle}>
        <h3 class="fd-toc-title">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <line x1="3" y1="6" x2="21" y2="6" />
            <line x1="3" y1="12" x2="15" y2="12" />
            <line x1="3" y1="18" x2="18" y2="18" />
          </svg>
          On this page
        </h3>
        <ul class={`fd-toc-list ${tocStyle === "directional" ? "fd-toc-clerk" : ""}`} id="fd-toc-list" style={tocStyle === "directional" ? "position:relative" : ""}></ul>
      </div>
    </aside>
  )}
</div>

<script>
  function getItemOffset(depth) {
    if (depth <= 2) return 14;
    if (depth === 3) return 26;
    return 36;
  }

  function getLineOffset(depth) {
    return depth >= 3 ? 10 : 0;
  }

  function initDocsPage() {
    const container = document.querySelector('.fd-page-body');
    const tocList = document.getElementById('fd-toc-list');
    const tocAside = document.getElementById('fd-toc');
    if (container && tocList) {
      const headings = container.querySelectorAll('h2[id], h3[id], h4[id]');
      const isClerk = tocList.closest('[data-toc-style]')?.getAttribute('data-toc-style') === 'directional';

      const tocItems = [];
      headings.forEach(el => {
        tocItems.push({
          id: el.id,
          title: el.textContent?.replace(/^#\s*/, '') || '',
          depth: parseInt(el.tagName[1], 10),
        });
      });

      const fragment = document.createDocumentFragment();
      tocItems.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'fd-toc-item';
        const a = document.createElement('a');
        a.href = `#${item.id}`;

        if (isClerk) {
          a.className = 'fd-toc-link fd-toc-clerk-link';
          a.style.position = 'relative';
          a.style.paddingLeft = `${getItemOffset(item.depth)}px`;
          a.style.paddingTop = '6px';
          a.style.paddingBottom = '6px';
          a.style.fontSize = item.depth <= 2 ? '14px' : '13px';
          a.style.overflowWrap = 'anywhere';

          const prevDepth = index > 0 ? tocItems[index - 1].depth : item.depth;
          const nextDepth = index < tocItems.length - 1 ? tocItems[index + 1].depth : item.depth;
          const lineDiv = document.createElement('div');
          lineDiv.style.position = 'absolute';
          lineDiv.style.left = `${getLineOffset(item.depth)}px`;
          lineDiv.style.top = prevDepth !== item.depth ? '6px' : '0';
          lineDiv.style.bottom = nextDepth !== item.depth ? '6px' : '0';
          lineDiv.style.width = '1px';
          lineDiv.style.background = 'hsla(0, 0%, 50%, 0.1)';
          a.appendChild(lineDiv);

          if (index > 0 && tocItems[index - 1].depth !== item.depth) {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 16 16');
            svg.setAttribute('width', '16');
            svg.setAttribute('height', '16');
            svg.style.position = 'absolute';
            svg.style.top = '-6px';
            svg.style.left = '0';
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', String(getLineOffset(tocItems[index - 1].depth)));
            line.setAttribute('y1', '0');
            line.setAttribute('x2', String(getLineOffset(item.depth)));
            line.setAttribute('y2', '12');
            line.setAttribute('stroke', 'hsla(0, 0%, 50%, 0.1)');
            line.setAttribute('stroke-width', '1');
            svg.appendChild(line);
            a.appendChild(svg);
          }

          a.appendChild(document.createTextNode(item.title));
        } else {
          a.className = 'fd-toc-link';
          a.style.paddingLeft = `${12 + (item.depth - 2) * 12}px`;
          a.textContent = item.title;
        }

        li.appendChild(a);
        fragment.appendChild(li);
      });

      tocList.replaceChildren(fragment);

      let maskEl = null;
      let thumbEl = null;

      if (isClerk) {
        function buildSvgPath() {
          const links = tocList.querySelectorAll('.fd-toc-clerk-link');
          if (links.length === 0) return null;
          const d = [];
          let w = 0, h = 0;
          links.forEach((el, i) => {
            if (i >= tocItems.length) return;
            const depth = tocItems[i].depth;
            const x = getLineOffset(depth) + 1;
            const styles = getComputedStyle(el);
            const top = el.offsetTop + parseFloat(styles.paddingTop);
            const bottom = el.offsetTop + el.clientHeight - parseFloat(styles.paddingBottom);
            w = Math.max(x, w);
            h = Math.max(h, bottom);
            d.push(`${i === 0 ? "M" : "L"}${x} ${top}`);
            d.push(`L${x} ${bottom}`);
          });
          return { path: d.join(" "), width: w + 1, height: h };
        }

        function updateThumb(activeSet) {
          if (!thumbEl) return;
          const links = tocList.querySelectorAll('.fd-toc-clerk-link');
          if (activeSet.size === 0 || links.length === 0) {
            thumbEl.style.marginTop = '0px';
            thumbEl.style.height = '0px';
            return;
          }
          let upper = Infinity, lower = 0;
          for (const id of activeSet) {
            const el = tocList.querySelector(`a[href="#${id}"]`);
            if (!el) continue;
            const styles = getComputedStyle(el);
            upper = Math.min(upper, el.offsetTop + parseFloat(styles.paddingTop));
            lower = Math.max(lower, el.offsetTop + el.clientHeight - parseFloat(styles.paddingBottom));
          }
          if (upper === Infinity) {
            thumbEl.style.marginTop = '0px';
            thumbEl.style.height = '0px';
            return;
          }
          thumbEl.style.marginTop = `${upper}px`;
          thumbEl.style.height = `${lower - upper}px`;
        }

        requestAnimationFrame(() => {
          const svgData = buildSvgPath();
          if (svgData) {
            maskEl = document.createElement('div');
            maskEl.className = 'fd-toc-clerk-mask';
            maskEl.style.position = 'absolute';
            maskEl.style.left = '0';
            maskEl.style.top = '0';
            maskEl.style.width = svgData.width + 'px';
            maskEl.style.height = svgData.height + 'px';
            maskEl.style.pointerEvents = 'none';
            const maskSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${svgData.width} ${svgData.height}"><path d="${svgData.path}" stroke="black" stroke-width="1" fill="none"/></svg>`;
            const maskUrl = `url("data:image/svg+xml,${encodeURIComponent(maskSvg)}")`;
            maskEl.style.maskImage = maskUrl;
            maskEl.style.webkitMaskImage = maskUrl;
            maskEl.style.maskRepeat = 'no-repeat';
            maskEl.style.webkitMaskRepeat = 'no-repeat';

            thumbEl = document.createElement('div');
            thumbEl.className = 'fd-toc-clerk-thumb';
            thumbEl.style.background = 'var(--color-fd-primary)';
            thumbEl.style.transition = 'all 0.15s';
            thumbEl.style.willChange = 'height, margin-top';
            thumbEl.style.marginTop = '0px';
            thumbEl.style.height = '0px';
            maskEl.appendChild(thumbEl);
            tocList.appendChild(maskEl);
          }
        });

        var clerkActiveSet = new Set();
      }

      const activeSet = new Set();
      let tocUpdateScheduled = false;
      let lastStableId = null;
      let scrollRafId = 0;
      const ACTIVE_ZONE_TOP = 120;
      const HYSTERESIS_PX = 65; /* same as Nuxt/Svelte â€” keeps TOC highlight smooth (no flicker) */

      function getDistanceToZone(id) {
        const el = document.getElementById(id);
        if (!el) return Infinity;
        const rect = el.getBoundingClientRect();
        const mid = rect.top + rect.height / 2;
        return Math.abs(mid - ACTIVE_ZONE_TOP);
      }

      function getClosestId() {
        let bestId = null;
        let bestDistance = Infinity;
        tocItems.forEach(function(item) {
          const d = getDistanceToZone(item.id);
          if (d < bestDistance) {
            bestDistance = d;
            bestId = item.id;
          }
        });
        return bestId;
      }

      function isInView(id) {
        const el = document.getElementById(id);
        if (!el) return false;
        const rect = el.getBoundingClientRect();
        return rect.top < window.innerHeight && rect.bottom > 0;
      }

      function applyActiveSet() {
        if (tocUpdateScheduled) return;
        tocUpdateScheduled = true;
        requestAnimationFrame(function() {
          tocUpdateScheduled = false;
          if (isClerk) {
            tocList.querySelectorAll('.fd-toc-clerk-link').forEach(function(link) {
              const id = link.getAttribute('href')?.slice(1);
              if (activeSet.has(id)) {
                link.setAttribute('data-active', 'true');
              } else {
                link.removeAttribute('data-active');
              }
            });
            if (typeof updateThumb === 'function') updateThumb(activeSet);
          } else {
            tocList.querySelectorAll('.fd-toc-link').forEach(function(link) {
              const id = link.getAttribute('href')?.slice(1);
              link.classList.toggle('fd-toc-link-active', activeSet.has(id));
            });
          }
        });
      }

      function updateTocFromScroll() {
        scrollRafId = 0;
        const newId = getClosestId();
        if (!newId) {
          activeSet.clear();
          applyActiveSet();
          return;
        }
        if (lastStableId === null) {
          lastStableId = newId;
          activeSet.clear();
          activeSet.add(newId);
          applyActiveSet();
          return;
        }
        if (newId === lastStableId) {
          activeSet.clear();
          activeSet.add(newId);
          applyActiveSet();
          return;
        }
        const newDist = getDistanceToZone(newId);
        const currentDist = getDistanceToZone(lastStableId);
        const switchToNew = newDist <= currentDist - HYSTERESIS_PX || !isInView(lastStableId);
        if (switchToNew) lastStableId = newId;
        activeSet.clear();
        activeSet.add(lastStableId);
        applyActiveSet();
      }

      function scheduleTocFromScroll() {
        if (scrollRafId !== 0) return;
        scrollRafId = requestAnimationFrame(updateTocFromScroll);
      }

      window.addEventListener('scroll', scheduleTocFromScroll, { passive: true, capture: true });
      document.addEventListener('scroll', scheduleTocFromScroll, { passive: true, capture: true });

      var initialId = getClosestId();
      if (initialId) {
        lastStableId = initialId;
        activeSet.add(initialId);
      }
      applyActiveSet();

      if (tocAside) tocAside.setAttribute('data-toc-ready', 'true');
    }

    // Copy buttons
    document.querySelectorAll('.fd-copy-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const code = btn.getAttribute('data-code')
          ?.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');
        if (!code) return;
        navigator.clipboard.writeText(code).then(() => {
          btn.classList.add('fd-copy-btn-copied');
          btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
          setTimeout(() => {
            btn.classList.remove('fd-copy-btn-copied');
            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>';
          }, 2000);
        });
      });
    });

    // Tabs
    document.querySelectorAll('[data-tabs]').forEach(tabs => {
      tabs.querySelectorAll('.fd-tab-trigger').forEach(trigger => {
        trigger.addEventListener('click', () => {
          const val = trigger.getAttribute('data-tab-value');
          tabs.querySelectorAll('.fd-tab-trigger').forEach(t => {
            t.classList.toggle('fd-tab-active', t.getAttribute('data-tab-value') === val);
            t.setAttribute('aria-selected', String(t.getAttribute('data-tab-value') === val));
          });
          tabs.querySelectorAll('.fd-tab-panel').forEach(p => {
            p.classList.toggle('fd-tab-panel-active', p.getAttribute('data-tab-panel') === val);
          });
        });
      });
    });
  }

  function runTocWhenIdle() {
    if (typeof requestIdleCallback !== 'undefined') {
      requestIdleCallback(() => initDocsPage(), { timeout: 300 });
    } else {
      setTimeout(initDocsPage, 0);
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runTocWhenIdle);
  } else {
    runTocWhenIdle();
  }
  document.addEventListener('astro:after-swap', () => setTimeout(initDocsPage, 0));
</script>
